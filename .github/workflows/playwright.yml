name: ðŸš€ Professional QA Pipeline - Dev to Prod
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev-only"
        type: choice
        options:
          - dev-only
          - full-pipeline
      browser:
        description: "Browser to test"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit
          - email-verification
          - api-testing

env:
  BASE_URL: http://localhost:3000
  NODE_ENV: test
  TEST_USER_EMAIL: test@example.com
  TEST_USER_PASSWORD: password123
  MAILINATOR_API_TOKEN: ${{ secrets.MAILINATOR_API_TOKEN }}
  MAILINATOR_DOMAIN: mailinator.com

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, webkit, firefox]
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Update build version with deployment count
        run: |
          # Generate version with deployment count based on current UTC time
          DATE=$(date -u +"%Y%m%d")
          TIME=$(date -u +"%H%M")

          # Get deployment count for today (simulate with run number)
          DEPLOY_COUNT=$(printf "%02d" ${{ github.run_number }})

          BUILD_VERSION="${DATE}_${DEPLOY_COUNT}_${TIME}"
          echo "Setting build version to: $BUILD_VERSION"

          # Update package.json with new versioning format
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$BUILD_VERSION\"/" package.json

          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "DEPLOY_DATE=$DATE" >> $GITHUB_ENV
          echo "DEPLOY_COUNT=$DEPLOY_COUNT" >> $GITHUB_ENV
          echo "DEPLOY_TIME=$TIME" >> $GITHUB_ENV

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Create test directories
        run: |
          mkdir -p test-results/screenshots
          mkdir -p test-results/videos
          mkdir -p test-results/traces

      - name: Start application server
        run: |
          npm run dev &
          sleep 10
          curl --retry 10 --retry-delay 5 --retry-connrefused http://localhost:3000 || exit 1

      - name: Run Playwright tests with deployment info
        run: |
          echo "ðŸš€ Running QA Test Suite for Deployment $BUILD_VERSION"
          echo "ðŸ“… Date: $(date)"
          echo "ðŸŒ Environment: ${{ github.ref_name }}"
          echo "ðŸ’» Browser: ${{ matrix.browser }}"
          echo "ðŸ”¢ Shard: ${{ matrix.shard }}/4"

          npx playwright test --project=${{ matrix.browser }} --shard=${{ matrix.shard }}/4
        env:
          CI: true
          PLAYWRIGHT_HTML_REPORT: test-results/html/report-${{ matrix.browser }}-shard-${{ matrix.shard }}

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: test-results/html/
          retention-days: 30

      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: test-results/screenshots/
          retention-days: 7

      - name: Upload Videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: test-results/videos/
          retention-days: 7

      - name: Upload Traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: traces-${{ matrix.browser }}-shard-${{ matrix.shard }}
          path: test-results/traces/
          retention-days: 7

  deploy-reports:
    if: always()
    needs: [test]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Merge test reports
        run: |
          echo "Merging test reports from all shards and browsers..."
          mkdir -p merged-reports

          # Create summary report
          echo "# QA Playwright Portfolio Test Results" > merged-reports/summary.md
          echo "" >> merged-reports/summary.md
          echo "**Test Execution Summary**" >> merged-reports/summary.md
          echo "- Date: $(date)" >> merged-reports/summary.md
          echo "- Browsers: Chromium, WebKit, Firefox" >> merged-reports/summary.md
          echo "- Test Shards: 4" >> merged-reports/summary.md
          echo "- Parallel Execution: Yes" >> merged-reports/summary.md
          echo "" >> merged-reports/summary.md
          echo "## Test Suites" >> merged-reports/summary.md
          echo "1. **Basic UI Tests** - Todo application functionality" >> merged-reports/summary.md
          echo "2. **Authentication Flows** - Login, registration, session management" >> merged-reports/summary.md
          echo "3. **Email Verification** - Mailinator integration testing" >> merged-reports/summary.md
          echo "4. **API Testing** - Backend integration and performance" >> merged-reports/summary.md

      - name: Upload merged reports
        uses: actions/upload-artifact@v4
        with:
          name: merged-test-reports
          path: merged-reports/
          retention-days: 90

      - name: Deploy to GitHub Pages (if main branch)
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./merged-reports
          destination_dir: test-reports

  slack-notification:
    if: always()
    needs: [test, deploy-reports]
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            QA Playwright Portfolio Test Results:
            - Browser Tests: ${{ needs.test.result }}
            - Report Deployment: ${{ needs.deploy-reports.result }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
