name: ğŸš€ Professional QA Pipeline - Dev to Prod

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to deploy"
                required: true
                default: "dev-only"
                type: choice
                options:
                    - dev-only
                    - full-pipeline

env:
    NODE_VERSION: "lts/*"

jobs:
    # ğŸ› ï¸ PHASE 1: Development Environment Testing
    dev-environment-tests:
        name: ğŸ› ï¸ Development Environment Validation
        timeout-minutes: 30
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                browser: [chromium, webkit]

        steps:
            - name: ğŸ“‹ Checkout repository
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: ğŸ“¦ Install dependencies
              run: npm ci

            - name: ğŸ­ Install Playwright browsers
              run: npx playwright install ${{ matrix.browser }} --with-deps

            - name: ğŸ—ï¸ Build application
              run: npm run build

            - name: ğŸš€ Start development server
              run: |
                  npm run preview &
                  sleep 10

            - name: ğŸ§ª Run development tests (${{ matrix.browser }})
              run: npx playwright test --project=${{ matrix.browser }} --config=playwright.config.ts
              env:
                  BASE_URL: http://localhost:4173

            - name: ğŸ“Š Upload test results (Dev)
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: dev-test-results-${{ matrix.browser }}
                  path: |
                      test-results/
                      playwright-report/
                  retention-days: 7

    # âœ… PHASE 2: Development Environment Status Check
    dev-environment-status:
        name: âœ… Development Environment - Status Gate
        needs: dev-environment-tests
        runs-on: ubuntu-latest
        if: always()

        outputs:
            dev-tests-passed: ${{ steps.check-dev.outputs.passed }}

        steps:
            - name: ğŸ” Check development test results
              id: check-dev
              run: |
                  if [[ "${{ needs.dev-environment-tests.result }}" == "success" ]]; then
                    echo "âœ… Development tests PASSED - Ready for production"
                    echo "passed=true" >> $GITHUB_OUTPUT
                    exit 0
                  else
                    echo "âŒ Development tests FAILED - Blocking production deployment"
                    echo "passed=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi

    # ğŸš€ PHASE 3: Production Deployment (Only if Dev Tests Pass)
    production-deployment:
        name: ğŸš€ Production Deployment
        needs: [dev-environment-tests, dev-environment-status]
        runs-on: ubuntu-latest
        if: |
            always() && 
            needs.dev-environment-status.outputs.dev-tests-passed == 'true' &&
            (github.event.inputs.environment == 'full-pipeline' || github.event.inputs.environment == '')

        steps:
            - name: ğŸ“‹ Checkout repository
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: ğŸ“¦ Install dependencies
              run: npm ci

            - name: ğŸ—ï¸ Build for production
              run: npm run build

            - name: ğŸ“¤ Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v3
              if: github.ref == 'refs/heads/main'
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./dist
                  force_orphan: true
                  user_name: 'github-actions[bot]'
                  user_email: 'github-actions[bot]@users.noreply.github.com'
                  commit_message: 'Deploy QA Portfolio ${{ github.sha }}'

    # ğŸ§ª PHASE 4: Production Environment Testing (Only after deployment)
    prod-environment-tests:
        name: ğŸ§ª Production Environment Validation
        needs: [production-deployment]
        runs-on: ubuntu-latest
        if: always() && needs.production-deployment.result == 'success'

        strategy:
            fail-fast: false
            matrix:
                browser: [chromium, webkit]

        steps:
            - name: ğŸ“‹ Checkout repository
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: ğŸ“¦ Install dependencies
              run: npm ci

            - name: ğŸ­ Install Playwright browsers
              run: npx playwright install ${{ matrix.browser }} --with-deps

            - name: â±ï¸ Wait for deployment
              run: sleep 60

            - name: ğŸŒ Test production environment (${{ matrix.browser }})
              run: npx playwright test --project=${{ matrix.browser }} --config=playwright.config.prod.ts
              env:
                  BASE_URL: https://faizdanialroslan.github.io/QA-Playwright-Demo-with-Javascript

            - name: ğŸ“Š Upload production test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: prod-test-results-${{ matrix.browser }}
                  path: |
                      test-results/
                      playwright-report/
                  retention-days: 30

    # ğŸ“Š PHASE 5: Final Pipeline Status
    pipeline-status:
        name: ğŸ“Š Pipeline Status Report
        needs:
            [
                dev-environment-tests,
                dev-environment-status,
                production-deployment,
                prod-environment-tests,
            ]
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: ğŸ“‹ Generate pipeline report
              run: |
                  echo "ğŸš€ QA PIPELINE EXECUTION REPORT"
                  echo "================================"
                  echo "ğŸ“… Date: $(date)"
                  echo "ğŸ”— Repository: ${{ github.repository }}"
                  echo "ğŸ“ Commit: ${{ github.sha }}"
                  echo ""
                  echo "ğŸ“Š PHASE RESULTS:"
                  echo "ğŸ› ï¸  Dev Tests: ${{ needs.dev-environment-tests.result }}"
                  echo "âœ… Dev Gate: ${{ needs.dev-environment-status.result }}"
                  echo "ğŸš€ Prod Deploy: ${{ needs.production-deployment.result }}"
                  echo "ğŸ§ª Prod Tests: ${{ needs.prod-environment-tests.result }}"
                  echo ""

                  if [[ "${{ needs.dev-environment-tests.result }}" == "success" ]]; then
                    echo "âœ… Development environment validation: PASSED"
                  else
                    echo "âŒ Development environment validation: FAILED"
                  fi

                  if [[ "${{ needs.prod-environment-tests.result }}" == "success" ]]; then
                    echo "âœ… Production environment validation: PASSED"
                    echo "ğŸŒ Live URL: https://faizdanialroslan.github.io/QA-Playwright-Demo-with-Javascript"
                  elif [[ "${{ needs.prod-environment-tests.result }}" == "skipped" ]]; then
                    echo "â­ï¸  Production testing: SKIPPED (dev tests failed)"
                  else
                    echo "âŒ Production environment validation: FAILED"
                  fi

            - name: ğŸ”” Set pipeline status
              run: |
                  if [[ "${{ needs.prod-environment-tests.result }}" == "success" || ("${{ needs.dev-environment-tests.result }}" == "success" && "${{ github.event.inputs.environment }}" == "dev-only") ]]; then
                    echo "âœ… QA Pipeline completed successfully!"
                    exit 0
                  else
                    echo "âŒ QA Pipeline failed - check logs for details"
                    exit 1
                  fi
